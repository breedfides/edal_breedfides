<!--

    Copyright (c) 2017 Leibniz Institute of Plant Genetics and Crop Plant Research (IPK), Gatersleben, Germany.
    All rights reserved. This program and the accompanying materials
    are made available under the terms of the Creative Commons Attribution-NoDerivatives 4.0 International (CC BY-ND 4.0)
    which accompanies this distribution, and is available at http://creativecommons.org/licenses/by-nd/4.0/

    Contributors:
         Leibniz Institute of Plant Genetics and Crop Plant Research (IPK), Gatersleben, Germany - initial API and implementation

-->
<!DOCTYPE html>
<html>
<head>
	<title>$title - $serverURL</title>
		#parse("de/ipk_gatersleben/bit/bi/edal/primary_data/HeaderTemplate.xml")
		
		#parse("de/ipk_gatersleben/bit/bi/edal/primary_data/MatamoTemplate.xml")
		
</head>
	<body>
		<div class="container-fluid">
			#parse("de/ipk_gatersleben/bit/bi/edal/primary_data/TopSectionTemplate.xml")
			
			<div class="content">
				<div class="row">
					<div class="col-md-1" style="margin-top:-7px;">
						<div class="row">
							<div class="error-img">
								#if($responseCode == 404)<i class="fa fa-5x fa-chain-broken text-danger"></i>#end
								#if($responseCode == 403)<i class="fa fa-5x fa-times-circle text-danger"></i>#end
								#if($responseCode == 423)<i class="fa fa-5x fa-lock text-danger"></i>#end
								#if($responseCode == 200)<i class="fa fa-3x fa-bar-chart text-danger"></i>#end
								#if($responseCode == 509)<i class="fa fa-5x fa-thumbs-down text-danger"></i>#end
								<!-- <input type="button" value="year" data-jq-dropdown="#jq-dropdown-1"
									class="btn btn-primary jq-dropdown-open" /> -->
									<br/>
									<br/>
									<b>Filter:</b>
									<br/>
									<a href="$serverURL/report">All</a>
									#foreach ($year in $years)
									<br/><a href="$serverURL/report/$year">$year</a>
									#end
									<br/>
									<b>Export:</b>
									<br/><a href="$serverURL/report/$filter/CSV">CSV</a><br/>
							</div>
						</div>
					</div>
					<div class="col-md-11">
						<div class="row">
							<div class="col-md-12-arendd" style="margin-bottom:-30px;">
								<h3>Request - Statistics</h3>
								<h4><b>DOIs: $dois - distinct client IP addresses: $totalAccesses - download volume: $totalDownloadVolume</b></h4>
							</div>
						</div>
						<div class="row">
							<div class="col-md-12-arendd">
								<ul class="list-unstyled">
									<div>
										<table id="tabelle" class="compact cell-border hover"
											width="100%">
											<thead>
												<tr>
													<th>DOI</th>
													<th>title</th>
													<th>distinct client IPs</th>
													<th>download volume</th>
													<th>
														worldmap
														<!-- <input type="checkbox" id="check_all" name="check_all"
															title="Show" /> -->
													</th>
												</tr>
											</thead>
											<tbody>
												#set ($counter = -1)
												#foreach ($entry in $accessStatistic)
												#set ($counter = $counter + 1)
												<tr>
													#foreach($line in $entry.split("\t"))
													#if($foreach.count==1)
														<td><a href="http://dx.doi.org/$line.toString()" target="_blank">$line.toString()</a></td>
														#set($length=$line.toString().length())
														#set($doi=$line.toString().substring(8,$length).replace("/",""))
													#end
													#if($foreach.count == 2)
														#set($length=$line.toString().length())
														<td>#if($length<100) $line.toString().substring(0,$length)</td>#end
														#if($length>=100) $line.toString().substring(0,100)...</td>#end
													#end
													#if($foreach.count == 3)<td>$line.toString()</td>#end
													#if($foreach.count == 4)<td>$line.toString()</td>#end
													#if($foreach.count == 5)
													<td>
													 	<input type="checkbox" id="check_$counter" name="check_$counter" title="Show" />
														<label for="check_$counter">Show</label> 
														<script>
															document.getElementById("check_$counter").onclick = function() {
																if(window.init == 0){
																	$("#worldmapul").toggle();
																	initialize();
																	window.init=1;
																	$(".dataTables_scrollBody").css({"height": ($(window).height())*0.7 });																													
																}
																if (document.getElementById("check_$counter").checked) {
																	if($("#worldmapul").is(":hidden")){
																		$("#worldmapul").toggle();
																	}
																	var xmlDoc = loadMyXml("$accessStatistic.get($counter).split('\t')[4]");
																	var data = "$doi";
																	eval("window.markers_" + data + "=new Array();");
																	if(window.markermaps == 0){
																		$(".dataTables_scrollBody").css({"height": ($(window).height()) * 0.35 });															
																		createMarkers(xmlDoc,window.markers_$doi,"marker_red.png");
																	}
																	if(window.markermaps == 1){createMarkers(xmlDoc,window.markers_$doi,"marker_green.png");}
																	if(window.markermaps == 2){createMarkers(xmlDoc,window.markers_$doi,"marker_blue.png");}
																	if(window.markermaps == 3){createMarkers(xmlDoc,window.markers_$doi,"marker_yellow.png");}
																	if(window.markermaps > 4){createMarkers(xmlDoc,window.markers_$doi,"marker_black.png");}
																	window.markermaps=window.markermaps+1;
																}
																else {
																	//alert(window.markermaps);
																	var temp = window.markers_$doi;
																	for (var i = 0; i < temp.length; i++){temp[i].setMap(null);}
																	window.markermaps=window.markermaps-1;
																	if(window.markermaps==0){
																		$("#worldmapul").toggle();
																		$(".dataTables_scrollBody").css({"height": ($(window).height())*0.7 });															
																	}
																}
															}
														</script>
													</td>
													#end
													#end
												</tr>
												#end
												<tfoot></tfoot>
											</tbody>
										</table>
									</div>
								</ul>
							</div>
						</div>	
					</div>
				</div>
				<hr />
				<div class="footer">
					<ul class="list-inline muted pad">
						<li class="marg" style="margin-left: -8px;">
							<small><b>e!DAL-Server at $serverURL.getHost():$serverURL.getPort() - data volume: $datastock - number of files: $filenumber - active data contributors: $users</b></small>
						</li>
					</ul>
				</div>
			</div>
			<div id="worldmapul" style="display:none;">
				<div class="map" id="worldmap" style="width: 100%; height: 320px; "></div>
			</div>
		</div>

		<script type="text/javascript" src="$serverURL/JS/datatable.js"></script>
		<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCijZGmmBN1zUiQkCvJ58dBvzvx32FWKXE"></script>
		<script type="text/javascript">
			function initialize() {
				window.map = new google.maps.Map(document.getElementById('worldmap'), {
					center : new google.maps.LatLng(38, 15),
					zoom : 1,
					mapTypeId : google.maps.MapTypeId.TERRAIN
				});
				window.markermaps=0;
			}
			function createMarkers(xmlDoc, markersArray, markerImage) {
				var iconPath = "/FILEICONS/".concat(markerImage);
				var items =
				xmlDoc.getElementsByTagName('marker');
				var latlng;
				for (var i = 0; i <	items.length; i++) {
					latlng = new google.maps.LatLng(items[i].getAttribute('lat'),items[i].getAttribute('lng'));
					window.marker = new	google.maps.Marker({position:latlng, title:items[i].getAttribute('title'), map:map, icon:iconPath});
					markersArray.push(marker);
				}
			}
			function loadMyXml(xmlUrl) {
				if(window.DOMParser){
					parser=new DOMParser();
					xmlDoc=parser.parseFromString(xmlUrl,"text/xml");
				}
				else{
					xmlDoc=new ActiveXObject("Microsoft.XMLDOM");
					xmlDoc.async=false;
					xmlDoc.loadXML(xmlUrl);
				}
			return xmlDoc;
			}
			google.maps.event.addDomListener(window, 'load', initialize);
		</script>
	</body>
</html>